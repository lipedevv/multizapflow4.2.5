#!/bin/bash

# reset shell colors
tput init

# https://stackoverflow.com/questions/59895/how-to-get-the-source-directory-of-a-bash-script-from-within-the-script-itself
SOURCE="${BASH_SOURCE[0]}"
while [ -h "$SOURCE" ]; do # resolve $SOURCE until the file is no longer a symlink
  PROJECT_ROOT="$( cd -P "$( dirname "$SOURCE" )" >/dev/null 2>&1 && pwd )"
  SOURCE="$(readlink "$SOURCE")"
  [[ $SOURCE != /* ]] && SOURCE="$PROJECT_ROOT/$SOURCE" # if $SOURCE was a relative symlink, we need to resolve it relative to the path where the symlink file was located
done
PROJECT_ROOT="$( cd -P "$( dirname "$SOURCE" )" >/dev/null 2>&1 && pwd )"

sed -i "/#\$nrconf{restart} = 'i';/s/.*/\$nrconf{restart} = 'a';/" /etc/needrestart/needrestart.conf

# required imports
source "${PROJECT_ROOT}"/variables/manifest.sh
source "${PROJECT_ROOT}"/utils/manifest.sh
source "${PROJECT_ROOT}"/lib/manifest.sh

# user configs file
if [[ ! -e "${PROJECT_ROOT}"/config ]]; then
  cat << EOF > "${PROJECT_ROOT}"/config
deploy_password=${deploy_password}
mysql_root_password=${mysql_root_password}
db_pass=${db_pass}
EOF
fi

# this file has passwords
sudo su - root <<EOF
chown root:root "${PROJECT_ROOT}"/config
chmod 700 "${PROJECT_ROOT}"/config
EOF
source "${PROJECT_ROOT}"/config

# interactive CLI
inquiry_options

# Generate JWT secrets if not already set
if [ -z "$jwt_secret" ] || [ -z "$jwt_refresh_secret" ]; then
  print_banner
  printf "${WHITE} ğŸ’» Gerando segredos JWT...${GRAY_LIGHT}"
  printf "\n\n"
  
  jwt_secret=$(openssl rand -base64 64 | tr -d '\n')
  jwt_refresh_secret=$(openssl rand -base64 64 | tr -d '\n')
  
  # Save to config file
  echo "jwt_secret=${jwt_secret}" >> "${PROJECT_ROOT}"/config
  echo "jwt_refresh_secret=${jwt_refresh_secret}" >> "${PROJECT_ROOT}"/config
  
  printf "${GREEN}   âœ… Segredos JWT gerados automaticamente${GRAY_LIGHT}\n"
  sleep 2
fi

# ConfiguraÃ§Ãµes automÃ¡ticas do Redis
redis_host="localhost"
redis_password="${mysql_root_password}"

printf "\n${GREEN}   âœ… Redis configurado automaticamente:${GRAY_LIGHT}"
printf "\n${GREEN}      Host: localhost | Senha: mesma do banco${GRAY_LIGHT}\n"
sleep 2

print_banner
printf "${WHITE} ğŸš€ Iniciando instalaÃ§Ã£o completa do Multizap...${GRAY_LIGHT}"
printf "\n\n"
printf "${WHITE} ğŸ“ ConfiguraÃ§Ãµes:${GRAY_LIGHT}"
printf "\n"
printf "${WHITE}    ğŸ¢ InstÃ¢ncia: ${instancia_add}${GRAY_LIGHT}"
printf "\n"
printf "${WHITE}    ğŸŒ Frontend: ${frontend_url}:${frontend_port}${GRAY_LIGHT}"
printf "\n"
printf "${WHITE}    ğŸ”§ Backend: ${backend_url}:${backend_port}${GRAY_LIGHT}"
printf "\n"
printf "${WHITE}    ğŸ—„ï¸  Redis: ${redis_host}:${redis_port} (AutomÃ¡tico)${GRAY_LIGHT}"
printf "\n"
printf "${WHITE}    ğŸ‘¥ UsuÃ¡rios: ${max_user} | ConexÃµes: ${max_whats}${GRAY_LIGHT}"
printf "\n\n"

sleep 3

# dependencies related
printf "${WHITE} ğŸ“¦ Instalando dependÃªncias do sistema...${GRAY_LIGHT}\n"
system_update
system_node_install
system_docker_install
system_puppeteer_dependencies
system_pm2_install
system_snapd_install
system_nginx_install
system_certbot_install

# system config
printf "${WHITE} ğŸ”§ Configurando sistema...${GRAY_LIGHT}\n"
system_create_user

# backend related
printf "${WHITE} ğŸ› ï¸  Configurando backend...${GRAY_LIGHT}\n"
system_create_folder
system_mv_folder
system_unzip_Multizap
backend_set_env
backend_redis_create
backend_node_dependencies
backend_node_build
backend_db_migrate
backend_db_seed
backend_start_pm2
backend_nginx_setup

# frontend related
printf "${WHITE} ğŸ¨ Configurando frontend...${GRAY_LIGHT}\n"
frontend_set_env
frontend_node_dependencies
frontend_node_build
frontend_start_pm2
frontend_nginx_setup

# network related
printf "${WHITE} ğŸŒ Configurando rede...${GRAY_LIGHT}\n"
system_nginx_conf
system_nginx_restart
system_certbot_setup

# Final setup and verification
print_banner
printf "${WHITE} ğŸ” Verificando serviÃ§os...${GRAY_LIGHT}"
printf "\n\n"

sleep 2

# Verify services
printf "${WHITE} ğŸ”„ Verificando PM2...${GRAY_LIGHT}\n"
sudo su - deploy <<EOF
echo "ğŸ“Š Listando processos PM2..."
pm2 list

echo "ğŸ” Verificando backend..."
sleep 5
if curl -f http://localhost:${backend_port}/ >/dev/null 2>&1; then
  echo "âœ… Backend respondendo na porta ${backend_port}"
else
  echo "âš ï¸  Backend nÃ£o respondeu imediatamente, aguardando..."
  sleep 10
  curl -f http://localhost:${backend_port}/ && echo "âœ… Backend respondendo" || echo "âŒ Backend nÃ£o responde"
fi

echo "ğŸ” Verificando frontend..."
if curl -f http://localhost:${frontend_port}/ >/dev/null 2>&1; then
  echo "âœ… Frontend respondendo na porta ${frontend_port}"
else
  echo "âš ï¸  Frontend nÃ£o respondeu imediatamente"
fi
EOF

# Verify Redis
printf "${WHITE} ğŸ”„ Verificando Redis...${GRAY_LIGHT}\n"
sudo su - root <<EOF
echo "ğŸ³ Verificando container Redis..."
if docker ps | grep -q "redis-${instancia_add}"; then
  echo "âœ… Container Redis estÃ¡ rodando"
else
  echo "âŒ Container Redis nÃ£o estÃ¡ rodando"
  exit 1
fi

echo "ğŸ”— Testando conexÃ£o com Redis..."
if docker exec redis-${instancia_add} redis-cli -a ${redis_password} ping | grep -q "PONG"; then
  echo "âœ… ConexÃ£o Redis OK"
  echo "ğŸ“Š ConfiguraÃ§Ã£o Redis:"
  echo "   ğŸ  Host: localhost"
  echo "   ğŸ”‘ Senha: mesma do banco"
  echo "   ğŸ“ Porta: ${redis_port}"
else
  echo "âŒ Falha na conexÃ£o Redis"
  exit 1
fi
EOF

sleep 2

print_banner
printf "${GREEN} âœ… InstalaÃ§Ã£o do Multizap concluÃ­da com sucesso!${GRAY_LIGHT}"
printf "\n\n"
printf "${WHITE} ğŸ“Š Resumo da instalaÃ§Ã£o:${GRAY_LIGHT}"
printf "\n"
printf "${WHITE}    ğŸ¢ InstÃ¢ncia: ${instancia_add}${GRAY_LIGHT}"
printf "\n"
printf "${WHITE}    ğŸŒ Frontend: ${frontend_url}${GRAY_LIGHT}"
printf "\n"
printf "${WHITE}    ğŸ”§ Backend: ${backend_url}${GRAY_LIGHT}"
printf "\n"
printf "${WHITE}    ğŸ—„ï¸  Redis: ${redis_host}:${redis_port} (AutomÃ¡tico)${GRAY_LIGHT}"
printf "\n"
printf "${WHITE}    ğŸ‘¥ Limite de usuÃ¡rios: ${max_user}${GRAY_LIGHT}"
printf "\n"
printf "${WHITE}    ğŸ“ Limite de conexÃµes: ${max_whats}${GRAY_LIGHT}"
printf "\n\n"
printf "${WHITE} ğŸ”§ Comandos Ãºteis:${GRAY_LIGHT}"
printf "\n"
printf "${WHITE}    Ver logs: pm2 logs ${instancia_add}-backend${GRAY_LIGHT}"
printf "\n"
printf "${WHITE}    Reiniciar: pm2 restart ${instancia_add}-backend${GRAY_LIGHT}"
printf "\n"
printf "${WHITE}    Status: pm2 status${GRAY_LIGHT}"
printf "\n"
printf "${WHITE}    Redis: docker logs redis-${instancia_add}${GRAY_LIGHT}"
printf "\n\n"
printf "${WHITE} ğŸ¯ PrÃ³ximos passos:${GRAY_LIGHT}"
printf "\n"
printf "${WHITE}    1. Acesse ${frontend_url}${GRAY_LIGHT}"
printf "\n"
printf "${WHITE}    2. Configure o WhatsApp no painel${GRAY_LIGHT}"
printf "\n"
printf "${WHITE}    3. Teste o agendamento de mensagens (Redis)${GRAY_LIGHT}"
printf "\n\n"

sleep 3
